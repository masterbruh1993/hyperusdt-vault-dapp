<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HyperUSDT – BSC Mainnet</title>
<style>
  /* same styles mo dito */
</style>
</head>
<body>
<div class="wrap">
  <!-- HEADER -->
  <div class="card">
    <h1>HyperUSDT <span class="muted">— BSC Mainnet</span></h1>
    <div class="muted">Passive: <b><span id="dailyRate">—</span> daily × 30d</b> (claim 1×/day) • Referrals: <b>15/1/1/1/2%</b> instant</div>
    <div class="muted">Vault: <span id="vault" class="mono">—</span></div>
    <div class="muted">Connected: <span id="acct" class="mono">—</span> <span id="role" class="pill" style="margin-left:8px">—</span></div>
    <div style="margin-top:10px"><button id="connect">Connect Wallet</button></div>
  </div>
  
  <!-- rest ng UI mo unchanged -->
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>

<script>
/* ---------- CONFIG ---------- */
const VAULT_ADDR = "0x4e46be238c79ec89322b4b54e1ba4bb921741da8";
const USDT_ADDR  = "0x55d398326f99059fF775485246999027B3197955";
const OWNER_ADDR = "0x3cf4C30204c99F718d1352417B9eC836bae87Fa9";
const CHAIN_ID   = 56;

const VAULT_ABI = [/* yung buong ABI mo dito */];
const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function approve(address,uint256) external returns (bool)"
];

let provider, signer, acct, vault, usdt, usdtDecimals = 18;
const $ = (id)=>document.getElementById(id);

$("vault").textContent = VAULT_ADDR;
$("usdt").textContent  = USDT_ADDR;

/* ---------- REF HELPERS ---------- */
function isAddr(a){ try{ return ethers.isAddress(a); }catch{ return false; } }
function getRefFromURL(){
  const p = new URLSearchParams(window.location.search).get("ref") || "";
  return p && isAddr(p) ? p : "";
}
function setRefInURL(addr){
  try{
    const url = new URL(window.location.href);
    url.searchParams.set("ref", addr);
    history.replaceState({}, "", url.toString());
  }catch(_){}
}
function refreshPersonalRefLink(){
  if(!acct){ $("reflink").textContent = "—"; return; }
  const u = new URL(window.location.href);
  u.searchParams.set("ref", acct);
  $("reflink").textContent = u.toString();
}

/* ---------- CONNECT ---------- */
async function connect(){
  await window.ethereum.request({ method: "eth_requestAccounts" });
  await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0x38" }] });

  provider = new ethers.BrowserProvider(window.ethereum);
  signer   = await provider.getSigner();
  acct     = await signer.getAddress();
  $("acct").textContent = acct;

  vault = new ethers.Contract(VAULT_ADDR, VAULT_ABI, signer);
  usdt  = new ethers.Contract(USDT_ADDR, ERC20_ABI, signer);
  usdtDecimals = await usdt.decimals();

  const on = (await vault.owner()).toLowerCase();
  const isOwner = acct.toLowerCase() === on || acct.toLowerCase() === OWNER_ADDR.toLowerCase();
  $("role").textContent = isOwner ? "OWNER" : "USER";
  $("ownerCard").style.display = isOwner ? "block" : "none";

  const incomingRef = getRefFromURL();
  if (incomingRef) $("refAddr").value = incomingRef;
  else setRefInURL(acct);

  refreshPersonalRefLink();
  await refreshStats();
  setInterval(refreshStats, 20000); // auto-refresh
}

/* ---------- REFRESH STATS ---------- */
async function refreshStats(){
  if(!acct || !vault || !usdt) return;
  try {
    const [
      balRaw,
      userInfo,
      pendingRaw,
      vaultBalRaw,
      dailyRateBP,
      allowanceRaw
    ] = await Promise.all([
      usdt.balanceOf(acct),
      vault.users(acct),
      vault.pendingPassive(acct),
      vault.vaultBalance(),
      vault.dailyRateBP(),
      usdt.allowance(acct, VAULT_ADDR)
    ]);

    $("bal").textContent        = ethers.formatUnits(balRaw, usdtDecimals);
    $("pending").textContent    = ethers.formatUnits(pendingRaw, usdtDecimals);
    $("vaultBal").textContent   = ethers.formatUnits(vaultBalRaw, usdtDecimals);
    $("dailyRate").textContent  = (Number(dailyRateBP)/100).toFixed(2) + "%";
    $("allow").textContent      = ethers.formatUnits(allowanceRaw, usdtDecimals);
    $("allowWarn").style.display= Number(ethers.formatUnits(allowanceRaw, usdtDecimals)) < 0.001 ? "inline-block" : "none";

  } catch(e){ console.error(e); }
}

/* ---------- APPROVE ---------- */
async function approve(){
  const amt = $("approveAmt").value.trim();
  if(!amt) return alert("Enter amount");
  const v = ethers.parseUnits(amt, usdtDecimals);
  const tx = await usdt.approve(VAULT_ADDR, v);
  await tx.wait();
  alert("Approved!");
  await refreshStats();
}

/* ---------- DEPOSIT ---------- */
async function deposit(){
  const amt = $("depAmt").value.trim();
  if(!amt) return alert("Enter amount");
  const v = ethers.parseUnits(amt, usdtDecimals);

  const curAllowance = await usdt.allowance(acct, VAULT_ADDR);
  if (curAllowance < v) {
    await approve();
  }

  let ref = getRefFromURL() || $("refAddr").value.trim();
  if(!isAddr(ref) || ref.toLowerCase() === acct.toLowerCase()){
    ref = ethers.ZeroAddress;
  }

  const tx = await vault.deposit(v, ref);
  await tx.wait();
  alert("Deposited!");
  await refreshStats();
}

/* ---------- CLAIM ---------- */
async function claim(){
  const tx = await vault.claimPassive();
  await tx.wait();
  alert("Claimed!");
  await refreshStats();
}

/* ---------- OWNER WITHDRAW ---------- */
async function ownerWithdrawAmount(){
  const amt = $("wdAmt").value.trim();
  if(!amt) return alert("Enter amount");
  const v = ethers.parseUnits(amt, usdtDecimals);
  const tx = await vault.ownerWithdraw(v, acct);
  await tx.wait();
  alert("Withdrawn!");
  await refreshStats();
}
async function ownerWithdrawAll(){
  if(!confirm("Withdraw ALL USDT?")) return;
  const tx = await vault.ownerWithdrawAll(acct);
  await tx.wait();
  alert("All funds withdrawn!");
  await refreshStats();
}

/* ---------- UI HOOKS ---------- */
$("connect").onclick = connect;
$("approveBtn").onclick = approve;
$("depositBtn").onclick = deposit;
$("claim").onclick = claim;
$("refresh").onclick = refreshStats;
$("withdrawBtn").onclick = ownerWithdrawAmount;
$("withdrawAllBtn").onclick = ownerWithdrawAll;
$("copyRef").onclick = async ()=>{
  const t = $("reflink").textContent;
  if(t && t!=="—") {
    await navigator.clipboard.writeText(t);
    $("copyMsg").textContent="Copied!";
    setTimeout(()=>{$("copyMsg").textContent="";},1500);
  }
};
</script>
</body>
</html>
